<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCI Cupping Form (Interactive)</title>
  <style>
    :root{
      --ink:#1a1a1a;
      --line:#2a2a2a;
      --bg:#fff;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#f2f2f2;color:var(--ink);font-family:var(--font)}
    .page{
      width:min(1400px, 98vw);
      margin:12px auto;
      background:var(--bg);
      border:1px solid #ccc;
      box-shadow:0 6px 24px rgba(0,0,0,.08);
      padding:14px;
    }

    /* Toolbar: same height/feel; Add/Remove are half-size */
    .toolbar{
      display:grid;
      grid-template-columns: 1.2fr 0.6fr 0.6fr 1.4fr 0.9fr 0.9fr; /* Print | Add | Remove | Export | Lang | Reset */
      gap:8px;
      align-items:stretch;
      padding:8px 10px;
      margin-bottom:10px;
      border:1px solid #ddd;
      border-radius:12px;
      background:#fafafa;
    }
    .toolbar button{
      font:inherit;
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      min-height:44px;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      white-space:nowrap;
      line-height:1.1;
    }
    .toolbar button:hover{border-color:#888}

    @media (max-width: 900px){
      .toolbar{
        grid-template-columns: 1fr 1fr; /* stacked 2 per row */
      }
    }

    /* RTL support */
    body[dir="rtl"] .header{flex-direction:row-reverse}
    body[dir="rtl"] .brand{text-align:left}
    body[dir="rtl"] .linefield{flex-direction:row-reverse}
    body[dir="rtl"] .linefield label{min-width:auto}
    body[dir="rtl"] .rowhead{flex-direction:row-reverse}
    body[dir="rtl"] .rowhead .rightlabel{flex-direction:row-reverse}
    body[dir="rtl"] .notes{grid-template-columns: 1fr 44px}
    body[dir="rtl"] .notes label{text-align:right}
    body[dir="rtl"] .helper{padding-left:0;padding-right:52px}
    body[dir="rtl"] .bottomTitle{flex-direction:row-reverse}

    .header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:2px solid var(--line);
      padding-bottom:8px;margin-bottom:10px;
    }
    .header-left{display:flex;flex-direction:column;gap:8px;font-size:14px}
    .linefield{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .linefield label{min-width:54px;font-weight:600}
    .linefield input{
      border:0;border-bottom:1px solid var(--ink);
      padding:6px 6px;min-width:220px;outline:none;font-size:14px;
    }
    .brand{text-align:right;font-size:12px;color:#333;line-height:1.2}
    .brand b{letter-spacing:.3px}

    /* Screen layout */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap:10px;
    }
    .sample{
      border:2px solid var(--line);
      padding:0;
      min-height:880px;
      display:flex;flex-direction:column;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
    }
    .sample .toprow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px 8px 10px;
      border-bottom:2px solid var(--line);
    }
    .sample .toprow .sampleNo{
      font-weight:700;font-size:13px;
      display:flex;flex-direction:column;gap:6px;
    }
    .sample .toprow input{
      border:0;border-bottom:1px solid var(--ink);
      outline:none;font-size:13px;padding:6px 6px;width:100%;
    }
    .scorebox{
      width:160px;border:2px solid var(--line);
      padding:8px;border-radius:10px;
      display:flex;flex-direction:column;gap:6px;align-items:stretch;background:#fff;
    }
    .scorebox .lbl{font-size:11px;color:#333;font-weight:700;text-align:center}
    .scorebox .total{
      font-size:22px;font-weight:800;text-align:center;
      border-top:1px solid #999;padding-top:6px;
    }
    .scorebox .subtot{
      font-size:11px;color:#222;font-weight:700;line-height:1.25;
      border-top:1px dashed #aaa;padding-top:6px;margin-top:2px;
    }
    .scorebox .checkroast{
      display:flex;align-items:center;justify-content:center;gap:8px;
      font-size:11px;font-weight:700;color:#333;margin-top:4px;
    }
    .scorebox input[type="checkbox"]{width:18px;height:18px}

    .section{border-bottom:1px solid #bbb;padding:10px 10px}
    .rowhead{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      font-weight:800;font-size:12px;letter-spacing:.2px;margin-bottom:6px;
    }
    .rowhead .rightlabel{
      font-weight:800;font-size:11px;color:#333;
      display:flex;gap:8px;align-items:center;
    }

    /* Slider with value bubble */
    .sliderwrap{display:flex;gap:10px;align-items:center}
    .scale{flex:1;display:flex;flex-direction:column;gap:6px; position:relative;}

    input[type="range"]{
      width:100%;
      -webkit-appearance:none;appearance:none;
      height:28px;background:transparent;margin:0;
      touch-action: pan-y;
      position:relative;
      z-index:2;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:3px;background:var(--ink);border-radius:999px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;
      width:20px;height:20px;border-radius:50%;
      background:#fff;border:2px solid var(--ink);
      margin-top:-9px;
    }
    input[type="range"]::-moz-range-track{height:3px;background:var(--ink);border-radius:999px}
    input[type="range"]::-moz-range-thumb{
      width:20px;height:20px;border-radius:50%;
      background:#fff;border:2px solid var(--ink);
    }

    .value-bubble{
      position:absolute;
      top:-2px;
      transform:translateX(-50%);
      width:30px;height:30px;
      border-radius:999px;
      border:2px solid var(--ink);
      background:var(--ink);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:10px;font-weight:900;
      pointer-events:none;
      z-index:3;
    }

    .ticks{display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#222}
    .ticks span{min-width:16px;text-align:center}
    .microhint{
      font-size:9px;color:#444;font-weight:700;
      display:flex;justify-content:space-between;margin-top:2px;letter-spacing:.1px;
    }

    .notes{
      margin-top:8px;
      display:grid;
      grid-template-columns: 44px 1fr;
      gap:8px;
      align-items:start;
    }
    .notes label{font-size:11px;font-weight:800;color:#333}
    .notes textarea{
      width:100%;min-height:44px;resize:vertical;
      border:0;border-top:1px solid #888;
      outline:none;padding:8px 8px 0 8px;font-size:12px;
    }

    .helper{
      margin-top:8px;
      display:flex;flex-wrap:wrap;gap:8px;
      padding-left:52px;
    }
    .chip{
      border:1px solid #bbb;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      min-height:34px;
      display:flex;align-items:center;
    }
    .chip:hover{border-color:#666}

    .circles{display:flex;gap:10px;align-items:center}
    .circle{
      width:18px;height:18px;border-radius:50%;
      border:2px solid var(--ink);
      background:#fff;cursor:pointer;
    }
    .circle.on{background:var(--ink)}

    .bottomRow{
      padding:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:auto;
    }
    .bottomItem{border-top:1px solid #bbb;padding-top:10px}
    .bottomTitle{
      display:flex;justify-content:space-between;align-items:center;
      font-size:12px;font-weight:900;
    }
    .bigcircles .circle{width:20px;height:20px}

    /* Mobile swipe cards */
    @media (max-width: 900px){
      .page{padding:10px}
      .grid{
        display:flex;
        gap:10px;
        overflow-x:auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding-bottom:8px;
      }
      .sample{
        flex:0 0 92%;
        scroll-snap-align: start;
        min-height:unset;
      }
      .scorebox{width:160px}
      .header{flex-direction:column;align-items:flex-start}
      .brand{text-align:left}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <button id="btnPrint" type="button"></button>
      <button id="btnAddSample" type="button"></button>
      <button id="btnRemoveSample" type="button"></button>
      <button id="btnExportReport" type="button"></button>
      <button id="btnLang" type="button"></button>
      <button id="btnReset" type="button"></button>
    </div>

    <div class="header">
      <div class="header-left">
        <div class="linefield">
          <label id="lblName" for="name"></label>
          <input id="name" type="text" />
        </div>
        <div class="linefield">
          <label id="lblTable" for="table"></label>
          <input id="table" type="text" />
        </div>
      </div>
      <div class="brand">
        <div style="font-size:11px;">SCI</div>
        <b>SUSTAINABLE COFFEE INSTITUTE</b><br/>
        <span style="font-weight:800;">CUPPING FORM</span>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

<script>
  /* ========== Language ========== */
  let lang = "en"; // "en" or "ar"

  const UI = {
    en: {
      print: "Print / Save as PDF",
      add: "+ Add",
      remove: "− Remove",
      export: "Export Star Graph",
      lang: "العربية",
      reset: "Reset",
      name: "NAME:",
      table: "TABLE:",
      sample: "SAMPLE #",
      total: "TOTAL SCORE",
      checkRoast: "CHECK ROAST",
      notes: "NOTES:",
      intensity: "INTENSITY",
      thickness: "THICKNESS",
      duration: "DURATION",
      woody: "WOODY",
      low: "LOW",
      high: "HIGH",
      flat: "FLAT",
      bright: "BRIGHT",
      thin: "THIN",
      thick: "THICK",
      short: "SHORT",
      long: "LONG",
      none: "NONE",
      intense: "INTENSE",
      uniformity: "UNIFORMITY",
      defect: "DEFECT",
      breakdown: "Attributes breakdown",
      tipAxes: "Axes include Uniformity & Defect. Unscored attributes are 0."
    },
    ar: {
      print: "طباعة / حفظ PDF",
      add: "+ إضافة",
      remove: "− حذف",
      export: "تصدير الرسم النجمي",
      lang: "English",
      reset: "إعادة ضبط",
      name: "الاسم:",
      table: "الطاولة:",
      sample: "رقم العينة",
      total: "المجموع",
      checkRoast: "فحص التحميص",
      notes: "ملاحظات:",
      intensity: "الشدة",
      thickness: "القوام",
      duration: "المدة",
      woody: "خشبي",
      low: "منخفض",
      high: "مرتفع",
      flat: "مسطح",
      bright: "لامع",
      thin: "خفيف",
      thick: "ثقيل",
      short: "قصير",
      long: "طويل",
      none: "لا يوجد",
      intense: "شديد",
      uniformity: "التجانس",
      defect: "العيوب",
      breakdown: "تفاصيل الخصائص",
      tipAxes: "المحاور تشمل التجانس والعيوب. أي خاصية غير مُسجّلة = 0."
    }
  };

  function setLanguage(newLang){
    lang = newLang;
    document.documentElement.lang = (lang === "ar") ? "ar" : "en";
    document.body.setAttribute("dir", (lang === "ar") ? "rtl" : "ltr");
    applyUIText();
    renderAll(); // rebuild UI with translated attribute labels
  }

  function applyUIText(){
    const t = UI[lang];
    document.getElementById("btnPrint").textContent = t.print;
    document.getElementById("btnAddSample").textContent = t.add;
    document.getElementById("btnRemoveSample").textContent = t.remove;
    document.getElementById("btnExportReport").textContent = t.export;
    document.getElementById("btnLang").textContent = t.lang;
    document.getElementById("btnReset").textContent = t.reset;
    document.getElementById("lblName").textContent = t.name;
    document.getElementById("lblTable").textContent = t.table;
  }

  /* ========== Form logic ========== */
  // Added ARABIC COFFEE + bilingual labels
  const ATTRS = [
    { key:'fragrance',  label:{en:'FRAGRANCE', ar:'العطر'},       right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'LOW', ar:UI.ar.low},  hintR:{en:'HIGH', ar:UI.ar.high} },
    { key:'aroma',      label:{en:'AROMA', ar:'الرائحة'},         right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'LOW', ar:UI.ar.low},  hintR:{en:'HIGH', ar:UI.ar.high} },
    { key:'flavor',     label:{en:'FLAVOR', ar:'النكهة'},         right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'LOW', ar:UI.ar.low},  hintR:{en:'HIGH', ar:UI.ar.high} },
    { key:'acidity',    label:{en:'ACIDITY', ar:'الحموضة'},       right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'FLAT', ar:UI.ar.flat},hintR:{en:'BRIGHT', ar:UI.ar.bright} },
    { key:'mouthfeel',  label:{en:'MOUTHFEEL', ar:'الإحساس بالفم'}, right:{en:'THICKNESS', ar:UI.ar.thickness}, hintL:{en:'THIN', ar:UI.ar.thin}, hintR:{en:'THICK', ar:UI.ar.thick} },
    { key:'sweetness',  label:{en:'SWEETNESS', ar:'الحلاوة'},     right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'LOW', ar:UI.ar.low},  hintR:{en:'HIGH', ar:UI.ar.high} },
    { key:'aftertaste', label:{en:'AFTERTASTE', ar:'الأثر'},      right:{en:'DURATION', ar:UI.ar.duration},   hintL:{en:'SHORT', ar:UI.ar.short}, hintR:{en:'LONG', ar:UI.ar.long} },
    { key:'freshcrop',  label:{en:'FRESH CROP', ar:'طازج/محصول'}, right:{en:'WOODY', ar:UI.ar.woody},        hintL:{en:'NONE', ar:UI.ar.none}, hintR:{en:'INTENSE', ar:UI.ar.intense} },
    { key:'arabic',     label:{en:'ARABIC COFFEE', ar:'قهوة عربية'}, right:{en:'INTENSITY', ar:UI.ar.intensity}, hintL:{en:'LOW', ar:UI.ar.low}, hintR:{en:'HIGH', ar:UI.ar.high} },
  ];

  const UNIFORMITY_BASE = 10;
  const DEFECT_BASE = 10;
  const DEDUCT_PER_CHECK = 2;

  const RANGE_MIN = 6.0;
  const RANGE_MAX = 10.0;
  const RANGE_STEP = 0.25;

  // Radar axes: attributes + uniformity + defect
  const RADAR_AXES = [
    ...ATTRS.map(a => ({ type:'attr', key:a.key, label: a.label })),
    { type:'metric', key:'uniformity', label:{en:'UNIFORMITY', ar:UI.ar.uniformity} },
    { type:'metric', key:'defect',     label:{en:'DEFECT', ar:UI.ar.defect} }
  ];

  const NOTE_HELPERS = {
    fragrance: ["Floral","Jasmine","Rose","Citrus","Chocolate","Caramel","Nutty","Spice","Earthy","Herbal"],
    aroma: ["Fruit-forward","Berry","Tropical","Sweet","Honey","Vanilla","Toasty","Fermented"],
    flavor: ["Clean","Complex","Balanced","Juicy","Bright","Sweet","Chocolatey","Nutty","Tea-like"],
    acidity: ["Citric","Malic","Tartaric","Phosphoric","Lactic","Bright","Soft","Sharp","Sour"],
    mouthfeel: ["Silky","Creamy","Velvety","Syrupy","Smooth","Coating","Watery","Astringent"],
    sweetness: ["Honey","Caramel","Brown sugar","Maple","High sweetness","Medium","Low"],
    aftertaste: ["Long","Short","Clean finish","Dry finish","Bitter finish","Fruity finish"],
    freshcrop: ["No woody","Slight woody","Woody","Baggy","Papery","Stale"],
    arabic: ["Cardamom","Saffron","Clove","Cinnamon","Toasty","Smoky","Herbal","Spicy"],
    uniformityNotes: ["All cups consistent","Slight variation","One cup off","Temp issue","Grind inconsistency"],
    defectNotes: ["Phenolic","Rubbery","Potato defect","Moldy","Earthy/musty","Smoky/ashy","Sour-ferment","Dirty","Baggy","Stale"]
  };

  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') n.className=v;
      else if(k==='html') n.innerHTML=v;
      else if(k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
      else n.setAttribute(k,v);
    });
    children.forEach(c=> n.appendChild(c));
    return n;
  }

  function newSampleState(){
    const obj = {
      sampleNo:'',
      checkRoast:false,
      uniformity:[false,false,false,false,false],
      defect:[false,false,false,false,false],
      uniformityNotes:'',
      defectNotes:''
    };
    ATTRS.forEach(a=>{
      obj[a.key] = { score:RANGE_MIN, scored:false, intensity:0, notes:'' };
    });
    return obj;
  }

  let state = { name:'', table:'', samples:[newSampleState(), newSampleState(), newSampleState()] };

  function circleGroup(sampleIdx, attrKey, groupKey, count=5){
    const wrap = el('div',{class:'circles', 'data-group':`${sampleIdx}.${attrKey}.${groupKey}`});
    for(let i=1;i<=count;i++){
      const c = el('div',{class:'circle', role:'button', tabindex:'0', 'aria-label':`${groupKey} ${i}`});
      c.addEventListener('click', ()=> setCircle(sampleIdx, attrKey, groupKey, i));
      c.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setCircle(sampleIdx, attrKey, groupKey, i); }
      });
      wrap.appendChild(c);
    }
    return wrap;
  }

  function setCircle(sampleIdx, attrKey, groupKey, value){
    const sel = `[data-group="${sampleIdx}.${attrKey}.${groupKey}"] .circle`;
    const cs = document.querySelectorAll(sel);
    cs.forEach((c, idx)=> c.classList.toggle('on', idx < value));
    state.samples[sampleIdx][attrKey][groupKey] = value;
  }

  function insertChipText(textarea, text){
    const insert = (textarea.value && !textarea.value.trim().endsWith(",")) ? ", " : "";
    textarea.value = (textarea.value ? textarea.value : "") + insert + text;
    textarea.dispatchEvent(new Event('input', {bubbles:true}));
    textarea.focus();
  }

  function helperRow(helperKey, textarea){
    const phrases = NOTE_HELPERS[helperKey] || [];
    if(!phrases.length) return null;
    const wrap = el('div',{class:'helper'});
    phrases.forEach(p=>{
      const chip = el('div',{class:'chip', role:'button', tabindex:'0', 'aria-label':`add ${p}`});
      chip.textContent = p;
      chip.addEventListener('click', ()=> insertChipText(textarea, p));
      chip.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); insertChipText(textarea, p); }
      });
      wrap.appendChild(chip);
    });
    return wrap;
  }

  function formatBubble(v){ return Number(v).toFixed(2); }

  function updateBubblePosition(rangeEl, bubbleEl){
    const min = Number(rangeEl.min), max = Number(rangeEl.max);
    const val = Number(rangeEl.value);
    const pct = (val - min) / (max - min);
    const w = rangeEl.getBoundingClientRect().width;
    const thumb = 20;
    const x = pct * (w - thumb) + (thumb/2);
    bubbleEl.style.left = `${x}px`;
    bubbleEl.textContent = formatBubble(val);
  }

  function sliderRow(sampleIdx, attr){
    const t = UI[lang];

    const row = el('div',{class:'section'});
    const head = el('div',{class:'rowhead'},[
      el('div',{html: attr.label[lang]}),
      el('div',{class:'rightlabel'},[
        el('span',{html: attr.right.en === "INTENSITY" ? t.intensity : (lang==="ar" ? attr.right.ar : attr.right.en)}),
        circleGroup(sampleIdx, attr.key, 'intensity', 5)
      ])
    ]);

    const range = el('input',{
      type:'range',
      min:String(RANGE_MIN),
      max:String(RANGE_MAX),
      step:String(RANGE_STEP),
      value:String(RANGE_MIN),
      'data-range': `${sampleIdx}.${attr.key}.score`
    });

    const bubble = el('div',{class:'value-bubble', 'data-bubble':`${sampleIdx}.${attr.key}`});

    const markScored = ()=> { state.samples[sampleIdx][attr.key].scored = true; };

    range.addEventListener('pointerdown', markScored, {passive:true});
    range.addEventListener('touchstart', markScored, {passive:true});
    range.addEventListener('mousedown', markScored);

    const sync = ()=> updateBubblePosition(range, bubble);

    range.addEventListener('input', ()=>{
      markScored();
      state.samples[sampleIdx][attr.key].score = Number(range.value);
      sync();
      updateTotals();
    });

    requestAnimationFrame(sync);
    window.addEventListener('resize', sync);

    const ticks = el('div',{class:'ticks'},[
      el('span',{html:'6'}), el('span',{html:'7'}), el('span',{html:'8'}), el('span',{html:'9'}), el('span',{html:'10'})
    ]);

    const hint = el('div',{class:'microhint'},[
      el('span',{html: attr.hintL[lang]}),
      el('span',{html: attr.hintR[lang]})
    ]);

    const notesWrap = el('div',{class:'notes'},[
      el('label',{html: t.notes}),
      el('textarea',{'data-notes':`${sampleIdx}.${attr.key}.notes`})
    ]);
    const textarea = notesWrap.querySelector('textarea');

    textarea.addEventListener('input', (e)=>{
      state.samples[sampleIdx][attr.key].notes = e.target.value;
    });

    row.appendChild(head);
    row.appendChild(el('div',{class:'sliderwrap'},[
      el('div',{class:'scale'},[range, bubble])
    ]));
    row.appendChild(ticks);
    row.appendChild(hint);
    row.appendChild(notesWrap);

    const helpers = helperRow(attr.key, textarea);
    if(helpers) row.appendChild(helpers);

    return row;
  }

  function renderBottomRow(sampleIdx, which){
    const cs = document.querySelectorAll(`[data-group="${sampleIdx}.${which}"] .circle`);
    cs.forEach((c, idx)=> c.classList.toggle('on', !!state.samples[sampleIdx][which][idx]));
  }

  function toggleBottomCircle(sampleIdx, which, idx){
    state.samples[sampleIdx][which][idx] = !state.samples[sampleIdx][which][idx];

    // Defect linked to Uniformity both ways (check/uncheck)
    if(which === 'defect'){
      state.samples[sampleIdx].uniformity[idx] = state.samples[sampleIdx].defect[idx];
    }

    renderBottomRow(sampleIdx, which);
    if(which === 'defect') renderBottomRow(sampleIdx, 'uniformity');

    updateTotals();
  }

  function buildBottomNotes(sampleIdx, which, helperKey, notesKey){
    const t = UI[lang];
    const title = (which === 'uniformity') ? t.uniformity : t.defect;

    const item = el('div',{class:'bottomItem'},[
      el('div',{class:'bottomTitle'},[
        el('div',{html: title}),
        el('div',{class:'circles bigcircles', 'data-group':`${sampleIdx}.${which}`})
      ]),
      el('div',{class:'notes'},[
        el('label',{html: t.notes}),
        el('textarea',{'data-notes':`${sampleIdx}.${notesKey}`})
      ])
    ]);

    for(let i=1;i<=5;i++){
      const c = el('div',{class:'circle', role:'button', tabindex:'0', 'aria-label':`${which} ${i}`});
      c.addEventListener('click', ()=> toggleBottomCircle(sampleIdx, which, i-1));
      c.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleBottomCircle(sampleIdx, which, i-1); }
      });
      item.querySelector(`[data-group="${sampleIdx}.${which}"]`).appendChild(c);
    }

    const ta = item.querySelector('textarea');
    ta.addEventListener('input', (e)=> state.samples[sampleIdx][notesKey] = e.target.value);

    const helpers = helperRow(helperKey, ta);
    if(helpers) item.appendChild(helpers);

    return item;
  }

  function buildSample(sampleIdx){
    const t = UI[lang];

    const sample = el('div',{class:'sample', 'data-sample':String(sampleIdx)});

    const sampleNo = el('div',{class:'sampleNo'},[
      el('div',{html: t.sample}),
      el('input',{type:'text', 'data-samplefield':`${sampleIdx}.sampleNo`})
    ]);

    const scorebox = el('div',{class:'scorebox'},[
      el('div',{class:'lbl', html: t.total}),
      el('div',{class:'total', 'data-total':String(sampleIdx), html:'0.00'}),
      el('div',{class:'subtot', 'data-subtot':String(sampleIdx), html:''}),
      el('div',{class:'checkroast'},[
        el('span',{html: t.checkRoast}),
        el('input',{type:'checkbox', 'data-samplefield':`${sampleIdx}.checkRoast`})
      ])
    ]);

    sample.appendChild(el('div',{class:'toprow'},[sampleNo, scorebox]));
    ATTRS.forEach(a => sample.appendChild(sliderRow(sampleIdx, a)));

    const bottom = el('div',{class:'bottomRow'});
    bottom.appendChild(buildBottomNotes(sampleIdx,'uniformity','uniformityNotes','uniformityNotes'));
    bottom.appendChild(buildBottomNotes(sampleIdx,'defect','defectNotes','defectNotes'));
    sample.appendChild(bottom);

    sample.querySelectorAll('[data-samplefield]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const [s, field] = inp.getAttribute('data-samplefield').split('.');
        if(field === 'checkRoast') state.samples[Number(s)].checkRoast = inp.checked;
        else state.samples[Number(s)][field] = inp.value;
      });
      if(inp.type === 'checkbox'){
        inp.addEventListener('change', ()=>{
          const [s, field] = inp.getAttribute('data-samplefield').split('.');
          state.samples[Number(s)][field] = inp.checked;
        });
      }
    });

    return sample;
  }

  function countTrue(arr){ return arr.reduce((n,v)=> n + (v?1:0), 0); }

  function computeSampleTotals(sample){
    // Attribute sum: only count if scored=true, otherwise 0
    const attributesSum = ATTRS.reduce((sum,a)=>{
      const obj = sample[a.key];
      const v = (obj && obj.scored) ? Number(obj.score || 0) : 0;
      return sum + v;
    }, 0);

    const uniChecks = countTrue(sample.uniformity);
    const defChecks = countTrue(sample.defect);

    const uniformityScore = UNIFORMITY_BASE - (uniChecks * DEDUCT_PER_CHECK);
    const defectScore     = DEFECT_BASE     - (defChecks * DEDUCT_PER_CHECK);

    const total = attributesSum + uniformityScore + defectScore;
    return { attributesSum, uniChecks, defChecks, uniformityScore, defectScore, total };
  }

  function updateTotals(){
    for(let i=0;i<state.samples.length;i++){
      const t = computeSampleTotals(state.samples[i]);

      const totalEl = document.querySelector(`[data-total="${i}"]`);
      const subEl   = document.querySelector(`[data-subtot="${i}"]`);
      if(!totalEl || !subEl) continue;

      totalEl.textContent = t.total.toFixed(2);
      // Keep subtotals simple (language-neutral numbers)
      subEl.innerHTML =
        `Attr: ${t.attributesSum.toFixed(2)}<br>` +
        `Uniformity: ${t.uniformityScore.toFixed(2)} (10 - ${t.uniChecks}×2)<br>` +
        `Defect: ${t.defectScore.toFixed(2)} (10 - ${t.defChecks}×2)`;
    }
  }

  function applyStateToUI(){
    document.getElementById('name').value = state.name || '';
    document.getElementById('table').value = state.table || '';

    for(let s=0;s<state.samples.length;s++){
      const sampleEl = document.querySelector(`[data-sample="${s}"]`);
      if(!sampleEl) continue;

      sampleEl.querySelectorAll('[data-samplefield]').forEach(inp=>{
        const [si, field] = inp.getAttribute('data-samplefield').split('.');
        if(Number(si)!==s) return;
        if(inp.type==='checkbox') inp.checked = !!state.samples[s][field];
        else inp.value = state.samples[s][field] || '';
      });

      ATTRS.forEach(a=>{
        const r = document.querySelector(`[data-range="${s}.${a.key}.score"]`);
        if(r){
          r.value = state.samples[s][a.key].score ?? RANGE_MIN;
          const bubble = document.querySelector(`[data-bubble="${s}.${a.key}"]`);
          if(bubble) updateBubblePosition(r, bubble);
        }

        const intensityVal = state.samples[s][a.key].intensity ?? 0;
        const cs = document.querySelectorAll(`[data-group="${s}.${a.key}.intensity"] .circle`);
        cs.forEach((c, idx)=> c.classList.toggle('on', idx < intensityVal));

        const n = document.querySelector(`[data-notes="${s}.${a.key}.notes"]`);
        if(n) n.value = state.samples[s][a.key].notes || '';
      });

      renderBottomRow(s,'uniformity');
      renderBottomRow(s,'defect');

      const un = document.querySelector(`[data-notes="${s}.uniformityNotes"]`);
      const dn = document.querySelector(`[data-notes="${s}.defectNotes"]`);
      if(un) un.value = state.samples[s].uniformityNotes || '';
      if(dn) dn.value = state.samples[s].defectNotes || '';
    }
    updateTotals();
  }

  function bindTopFields(){
    const nameEl = document.getElementById('name');
    const tableEl = document.getElementById('table');
    nameEl.addEventListener('input', (e)=> state.name = e.target.value);
    tableEl.addEventListener('input', (e)=> state.table = e.target.value);
  }

  function addSample(){
    const idx = state.samples.length;
    state.samples.push(newSampleState());
    renderAll();
  }

  function removeLastSample(){
    if(state.samples.length <= 1) return;
    state.samples.pop();
    renderAll();
  }

  function resetAll(){
    state = { name:'', table:'', samples:[newSampleState(), newSampleState(), newSampleState()] };
    renderAll();
  }

  /* ===== Export Star Graph Report (Radar) ===== */
  function escHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function radarValuesForSample(sample){
    const t = computeSampleTotals(sample);
    return RADAR_AXES.map(ax=>{
      if(ax.type === 'attr'){
        const obj = sample[ax.key];
        return (obj && obj.scored) ? Number(obj.score || 0) : 0;
      }
      if(ax.key === 'uniformity') return Number(t.uniformityScore || 0);
      if(ax.key === 'defect') return Number(t.defectScore || 0);
      return 0;
    });
  }

  function makeRadarSVG({labels, values, size=300, max=10}){
    const cx = size/2, cy = size/2;
    const r = size*0.38;
    const n = labels.length;
    const angle0 = -Math.PI/2;

    const rings = 5;
    const ringPts = (rad)=> Array.from({length:n}, (_,i)=>{
      const ang = angle0 + i*(2*Math.PI/n);
      return [cx + rad*Math.cos(ang), cy + rad*Math.sin(ang)];
    });

    const gridPolys = Array.from({length:rings}, (_,k)=>{
      const rad = r * ((k+1)/rings);
      const pts = ringPts(rad).map(p=>p.join(",")).join(" ");
      return `<polygon points="${pts}" fill="none" stroke="#bbb" stroke-width="1"/>`;
    }).join("");

    const axes = Array.from({length:n}, (_,i)=>{
      const ang = angle0 + i*(2*Math.PI/n);
      const x = cx + r*Math.cos(ang), y = cy + r*Math.sin(ang);
      return `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="#999" stroke-width="1"/>`;
    }).join("");

    const ptsVal = values.map((v,i)=>{
      const vv = Math.max(0, Math.min(max, Number(v||0)));
      const rad = r * (vv/max);
      const ang = angle0 + i*(2*Math.PI/n);
      return [cx + rad*Math.cos(ang), cy + rad*Math.sin(ang)];
    });

    const ptsStr = ptsVal.map(p=>p.join(",")).join(" ");
    const labelEls = labels.map((lab,i)=>{
      const ang = angle0 + i*(2*Math.PI/n);
      const lx = cx + (r*1.14)*Math.cos(ang);
      const ly = cy + (r*1.14)*Math.sin(ang);
      const anchor = (Math.abs(Math.cos(ang)) < 0.2) ? "middle" : (Math.cos(ang) > 0 ? "start" : "end");
      return `<text x="${lx}" y="${ly}" font-size="10" text-anchor="${anchor}" dominant-baseline="middle" fill="#111">${escHtml(lab)}</text>`;
    }).join("");

    const dots = ptsVal.map(([x,y])=> `<circle cx="${x}" cy="${y}" r="3" fill="#111"/>`).join("");

    return `
      <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
        <rect x="0" y="0" width="${size}" height="${size}" fill="#fff"/>
        ${gridPolys}
        ${axes}
        <polygon points="${ptsStr}" fill="rgba(0,0,0,0.08)" stroke="#111" stroke-width="2"/>
        ${dots}
        ${labelEls}
      </svg>`;
  }

  function exportStarGraphReport(){
    const tUI = UI[lang];

    const nameVal = document.getElementById('name')?.value || "";
    const tableVal = document.getElementById('table')?.value || "";
    const now = new Date();
    const stamp = now.toISOString().slice(0,19).replaceAll(":","-");

    const labels = RADAR_AXES.map(a=> a.label[lang]);

    const blocks = state.samples.map((sample, idx)=>{
      const totals = computeSampleTotals(sample);
      const radarVals = radarValuesForSample(sample);

      const uniformityChecks = sample.uniformity?.map(v=>v? "●":"○").join(" ") || "";
      const defectChecks = sample.defect?.map(v=>v? "●":"○").join(" ") || "";

      const svg = makeRadarSVG({labels, values: radarVals, size: 300, max: 10});

      const attrRows = ATTRS.map(a=>{
        const scored = !!sample[a.key]?.scored;
        const score = scored ? Number(sample[a.key].score||0).toFixed(2) : "0.00";
        const notes = sample[a.key]?.notes || "";
        return `
          <tr>
            <td style="padding:6px 8px;border:1px solid #ddd;font-weight:700;">${escHtml(a.label[lang])}</td>
            <td style="padding:6px 8px;border:1px solid #ddd;text-align:right;width:90px;">${escHtml(score)}</td>
            <td style="padding:6px 8px;border:1px solid #ddd;white-space:pre-wrap;">${escHtml(notes)}</td>
          </tr>`;
      }).join("");

      return `
        <section style="border:2px solid #111;border-radius:12px;padding:12px;margin:14px 0;background:#fff;">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;">
            <div>
              <div style="font-size:14px;font-weight:900;">${escHtml(tUI.sample)} ${idx+1} — ${escHtml(sample.sampleNo || "")}</div>
              <div style="margin-top:6px;font-size:12px;line-height:1.5;">
                <div><b>${escHtml(tUI.total)}:</b> ${totals.total.toFixed(2)}</div>
                <div><b>Attr Sum:</b> ${totals.attributesSum.toFixed(2)}</div>
                <div><b>${escHtml(tUI.uniformity)}:</b> ${totals.uniformityScore.toFixed(2)} (10 - ${totals.uniChecks}×2) &nbsp; <span style="font-family:monospace">${escHtml(uniformityChecks)}</span></div>
                <div><b>${escHtml(tUI.defect)}:</b> ${totals.defectScore.toFixed(2)} (10 - ${totals.defChecks}×2) &nbsp; <span style="font-family:monospace">${escHtml(defectChecks)}</span></div>
                <div><b>${escHtml(tUI.uniformity)} ${escHtml(tUI.notes)}</b> <span style="white-space:pre-wrap">${escHtml(sample.uniformityNotes||"")}</span></div>
                <div><b>${escHtml(tUI.defect)} ${escHtml(tUI.notes)}</b> <span style="white-space:pre-wrap">${escHtml(sample.defectNotes||"")}</span></div>
              </div>
            </div>
            <div style="min-width:300px;">
              ${svg}
              <div style="font-size:11px;color:#333;margin-top:6px;">${escHtml(tUI.tipAxes)}</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div style="font-weight:900;margin:8px 0 6px;">${escHtml(tUI.breakdown)}</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left;padding:6px 8px;border:1px solid #ddd;background:#f5f5f5;">Attribute</th>
                  <th style="text-align:right;padding:6px 8px;border:1px solid #ddd;background:#f5f5f5;">Score</th>
                  <th style="text-align:left;padding:6px 8px;border:1px solid #ddd;background:#f5f5f5;">Notes</th>
                </tr>
              </thead>
              <tbody>${attrRows}</tbody>
            </table>
          </div>
        </section>`;
    }).join("");

    const html = `<!doctype html>
<html lang="${lang}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCI Star Graph Report</title>
  <style>
    body{margin:0;background:#f2f2f2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;}
    body[dir="rtl"]{direction:rtl;}
    .wrap{max-width:1100px;margin:18px auto;padding:14px;}
    .card{background:#fff;border:1px solid #ddd;border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);}
    .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;}
    .h1{font-weight:1000;font-size:18px;}
    .meta{font-size:12px;line-height:1.5;color:#222;}
    @media print{
      body{background:#fff;}
      .wrap{max-width:none;margin:0;padding:0;}
      .card{border:0;box-shadow:none;border-radius:0;}
      section{page-break-inside:avoid;}
    }
  </style>
</head>
<body dir="${lang==="ar" ? "rtl":"ltr"}">
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="h1">SCI — ${escHtml(tUI.export)}</div>
          <div class="meta">
            <div><b>${escHtml(tUI.name)}</b> ${escHtml(nameVal)}</div>
            <div><b>${escHtml(tUI.table)}</b> ${escHtml(tableVal)}</div>
            <div><b>Exported:</b> ${escHtml(now.toLocaleString())}</div>
          </div>
        </div>
        <div class="meta" style="text-align:${lang==="ar" ? "left":"right"};">
          <div><b>Samples:</b> ${state.samples.length}</div>
        </div>
      </div>
      ${blocks}
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([html], {type:"text/html;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `SCI-StarGraph-Report-${stamp}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  /* ========== Render / rebuild preserving state ========== */
  function renderAll(){
    // Preserve name/table from inputs into state
    state.name = document.getElementById("name")?.value ?? state.name;
    state.table = document.getElementById("table")?.value ?? state.table;

    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    for(let i=0;i<state.samples.length;i++){
      grid.appendChild(buildSample(i));
    }

    // Re-bind top fields (safe)
    bindTopFields();

    // Restore name/table
    document.getElementById('name').value = state.name || '';
    document.getElementById('table').value = state.table || '';

    // Apply state values to sliders/bubbles/circles/notes
    applyStateToUI();
  }

  /* ========== Toolbar bindings ========== */
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  document.getElementById('btnReset').addEventListener('click', resetAll);
  document.getElementById('btnAddSample').addEventListener('click', addSample);
  document.getElementById('btnRemoveSample').addEventListener('click', removeLastSample);
  document.getElementById('btnExportReport').addEventListener('click', exportStarGraphReport);
  document.getElementById('btnLang').addEventListener('click', ()=> setLanguage(lang === "en" ? "ar" : "en"));

  /* ========== Init ========== */
  applyUIText();
  setLanguage("en"); // sets dir + renders
</script>
</body>
</html>