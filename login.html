<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCwrhMSBFbmvzQXkzEgtHBZZecrdbCN7ZU",
    authDomain: "sci-cupping-form.firebaseapp.com",
    projectId: "sci-cupping-form",
    storageBucket: "sci-cupping-form.firebasestorage.app",
    messagingSenderId: "789783909023",
    appId: "1:789783909023:web:35372ccd47c55f81bd08aa",
    measurementId: "G-V10NLBLZGQ"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    setPersistence,
    browserLocalPersistence,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail,
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const $ = (id)=>document.getElementById(id);
  const msg = (t)=>{ $("msg").textContent = t || ""; };

  // ✅ ثبّت الجلسة (يمنع bounce loop)
  await setPersistence(auth, browserLocalPersistence);

  // ✅ التقط نتيجة Google Redirect لو رجعت من جوجل
  try {
    await getRedirectResult(auth);
  } catch (e) {
    msg(e?.message || String(e));
  }

  // ✅ لو المستخدم مسجل، انقله للتطبيق (استخدم replace عشان ما يرجع back)
  onAuthStateChanged(auth, (user)=>{
    if (user) location.replace("app.html");
  });

  // ✅ Google login (Redirect بدل Popup)
  $("btnGoogle").onclick = async ()=>{
    msg("");
    try{
      const provider = new GoogleAuthProvider();
      await signInWithRedirect(auth, provider);
    }catch(e){
      msg(e?.message || String(e));
    }
  };

  // Email login
  $("btnLogin").onclick = async ()=>{
    msg("");
    try{
      await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value);
      location.replace("app.html");
    }catch(e){
      msg(e?.message || String(e));
    }
  };

  // Create account
  $("btnSignup").onclick = async ()=>{
    msg("");
    try{
      await createUserWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value);
      location.replace("app.html");
    }catch(e){
      msg(e?.message || String(e));
    }
  };

  // Reset password
  $("btnReset").onclick = async ()=>{
    msg("");
    try{
      await sendPasswordResetEmail(auth, $("email").value.trim());
      msg("Password reset email sent.");
    }catch(e){
      msg(e?.message || String(e));
    }
  };
</script>
